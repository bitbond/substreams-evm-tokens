-- TO-DO: Tuple(String, String) is not supported in Substreams SQL Sink
CREATE TABLE IF NOT EXISTS agg_records (
    node FixedString(66),
    kv_pairs_state AggregateFunction(groupArray, Tuple(String, String))
) ENGINE = AggregatingMergeTree
ORDER BY
    (node);

CREATE MATERIALIZED VIEW IF NOT EXISTS agg_records_mv TO agg_records AS
SELECT
    node,
    groupArrayState((key, value)) AS kv_pairs_state
FROM
    records
GROUP BY
    node;